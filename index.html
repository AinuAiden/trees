<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orchard</title>
    <link rel="icon" type="image/x-icon" href="golden-apple.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            align-items: center;
            background-color: #E4F3E5;
        }

        #container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
        }

        #treeContainer strong {
            color: #2c7a7b;
        }

        #noteFormContainer {
            margin-bottom: 20px;
            width: 100%;
        }

        #noteFormContainer iframe {
            width: 100%;
            height: 573px;
        }

        #canvasContainer {
            position: relative;
        }

        #orchardCanvas {
            width: 100%;
            height: auto;
        }

        #hoverInfo {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 5px;
            display: none;
            pointer-events: none;
        }

        #treeContainer,
        #canvasContainer {
            width: 100%;
            margin-bottom: 20px;
            height: auto;
        }

        #treeContainer {
            font-size: 14px;
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: left;
            width: 100%;
        }

        #hoverInfo {
            font-size: 12px;
        }

        .button {
            border-radius: 4px;
            background-color: green;
            border: none;
            color: #FFFFFF;
            text-align: center;
            font-size: 24px;
            padding: 15px;
            width: 80%;
            transition: all 0.5s;
            cursor: pointer;
            margin: auto;
        }

        .button span {
            cursor: pointer;
            display: inline-block;
            position: relative;
            transition: 0.5s;
        }

        .button span:after {
            content: '\00bb';
            position: absolute;
            opacity: 0;
            top: 0;
            right: -20px;
            transition: 0.5s;
        }

        .button:hover span {
            padding-right: 25px;
        }

        .button:hover span:after {
            opacity: 1;
            right: 0;
        }

        @media (max-width: 800px) {
            body {
                padding: 10px;
            }

            #container {
                flex-direction: column;
            }

        }
    </style>
</head>

<body>
    <div id="container">
        <div id="treeContainer">
            <div id="treeDetails"></div>
            <button id="makeNoteButton" class="button"><span>Make a note</span></button>
            <div id="noteFormContainer">
                <iframe id="googleForm" src="" frameborder="0" marginheight="0" marginwidth="0"
                    tabindex="-1">Loadingâ€¦</iframe>
            </div>
        </div>
        <div id="canvasContainer">
            <canvas id="orchardCanvas" width="250" height="500"></canvas>
            <div id="hoverInfo"></div>
        </div>
    </div>
    <script>
        const MAP_SCALE = 1.4;
        const PADDING = 40;
        const canvas = document.getElementById('orchardCanvas');
        const ctx = canvas.getContext('2d');
        const treeDetailsDiv = document.getElementById('treeDetails');
        const hoverInfoDiv = document.getElementById('hoverInfo');
        const googleForm = document.getElementById('googleForm');
        const noteFormContainer = document.getElementById('noteFormContainer');
        const makeNoteButton = document.getElementById('makeNoteButton');
        let trees = [];
        let notes = [];
        let selectedTreeId = null;

        class Tree {
            constructor(x, y, id, cultivar, rootstock, grade, grafter, graftType, grafteDate, nurseryDate, graftComment) {
                this.x = canvas.width - (x * MAP_SCALE + PADDING);
                this.y = (y + 30) * MAP_SCALE + PADDING;
                this.id = id;
                this.cultivar = cultivar;
                this.rootstock = rootstock;
                this.grade = grade;
                this.grafter = grafter;
                this.graftType = graftType;
                this.grafteDate = grafteDate;
                this.nurseryDate = nurseryDate;
                this.graftComment = graftComment;
            }

            getNotes() {
                return notes.filter(note => note.id == this.id);
            }
        }

        class Note {
            constructor(time, user, id, note) {
                this.time = time;
                this.user = user;
                this.id = id;
                this.note = note;
            }
        }

        function drawTrees() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            trees.forEach(tree => {
                ctx.beginPath();
                ctx.arc(tree.x, tree.y, tree.id === selectedTreeId ? 7 : 5, 0, Math.PI * 2);
                ctx.fillStyle = tree.id === selectedTreeId ? 'red' : 'green';
                ctx.fill();
            });
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) * (canvas.width / rect.width),
                y: (evt.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function isPointInTree(x, y, tree) {
            const distance = Math.sqrt((x - tree.x) ** 2 + (y - tree.y) ** 2);
            return distance <= 5;
        }

        function getNoteHTML(note) {
            return `
                <strong>${note.time} - ${note.user}</strong>
                <p>${note.note}</p>
            `;
        }

        function displayTreeDetails(tree) {
            selectedTreeId = tree.id;

            let notesHTML = "";
            tree.getNotes().forEach(note => notesHTML += getNoteHTML(note));

            treeDetailsDiv.innerHTML = `
                <h2>${tree.cultivar} [${tree.id}]</h2>
                <p><strong>Cultivar:</strong> ${tree.cultivar}</p>
                <p><strong>Rootstock:</strong> ${tree.rootstock}</p>
                <p><strong>Grade:</strong> ${tree.grade}</p>
                <h2>Graft Notes</h2>
                <p><strong>Grafter:</strong> ${tree.grafter}</p>
                <p><strong>Date:</strong> ${tree.grafteDate}</p>
                <p><strong>Type:</strong> ${tree.graftType}</p>
                ${tree.graftComment ? "<p><strong>Comment:</strong>"+tree.graftComment+"</p>": ""}
                ${notesHTML ? "<h2>Notes</h2>": ""}
                ${notesHTML}
            `;
            noteFormContainer.style.display = 'none'; // Hide note form initially
            makeNoteButton.style.display = 'block';
            drawTrees();
        }

        function showHoverInfo(tree, x, y) {
            hoverInfoDiv.style.display = 'block';
            hoverInfoDiv.style.left = `${x + 10}px`;
            hoverInfoDiv.style.top = `${y + 10}px`;
            hoverInfoDiv.innerHTML = `
                <strong>Tree ID:</strong> ${tree.id}<br>
                <strong>Cultivar:</strong> ${tree.cultivar}<br>
                <strong>Rootstock:</strong> ${tree.rootstock}<br>
                <strong>Grade:</strong> ${tree.grade}
            `;
        }

        function updateURLParameter(treeId) {
            const url = new URL(window.location);
            url.searchParams.set('treeId', treeId);
            window.history.pushState({}, '', url);
        }

        function updateGoogleForm(treeId) {
            const formUrl = `https://docs.google.com/forms/d/e/1FAIpQLSd4n5wpalR97KiW5ppOsb1fnqSRI2W4B_VH4x_y8y0F36UaQg/viewform?embedded=true&usp=pp_url&entry.1147721308=${treeId}`;
            if (googleForm.src !== formUrl) {
                googleForm.src = formUrl;
            }
        }


        function fetchTreeData() {
            const sheetId = '1boH22hYT8um6i3UyCf33GHJVZmnFic-k5TZsQmfNrHY';
            const sheetRange = 'map!A2:K';
            const apiKey = 'AIzaSyBs9Du6hrji1fMUaUcbAy7nviu7EssKkV0';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetRange}?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    trees = data.values.map(row => new Tree(
                        parseFloat(row[0]),
                        parseFloat(row[1]),
                        row[2],
                        row[3],
                        row[4],
                        row[5],
                        row[6],
                        row[7],
                        row[8],
                        row[9],
                        row[10],
                        row[11] || ''
                    ));
                    drawTrees();
                    fetchNotes();
                    initialize();
                })
                .catch(error => console.error('Error loading trees:', error));
        }

        function fetchNotes() {
            const sheetId = '1dH1oBXTx4CtOVU8jE7PhWrfM7iSyzekNAeW7QaOXcFc';
            const sheetRange = 'notes!A2:D';
            const apiKey = 'AIzaSyBs9Du6hrji1fMUaUcbAy7nviu7EssKkV0';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetRange}?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    notes = data.values.map(row => new Note(
                        row[0],
                        row[1],
                        row[2],
                        row[3] || ''
                    ));
                })
                .catch(error => console.error('Error loading notes:', error));
        }

        function initialize() {
            const treeId = new URLSearchParams(window.location.search).get('treeId');
            if (treeId) {
                const selectedTree = trees.find(tree => tree.id === treeId);
                if (selectedTree) {
                    displayTreeDetails(selectedTree);
                } else {
                    treeDetailsDiv.innerHTML = 'Tree not found.';
                }
            } else {
                updateGoogleForm(''); // Reset form if no tree is selected
            }
        }

        canvas.addEventListener('mousemove', function (evt) {
            const mousePos = getMousePos(canvas, evt);
            const hoveredTree = trees.find(tree => isPointInTree(mousePos.x, mousePos.y, tree));

            if (hoveredTree) {
                showHoverInfo(hoveredTree, mousePos.x, mousePos.y);
            } else {
                hoverInfoDiv.style.display = 'none';
            }
        });

        canvas.addEventListener('click', function (evt) {
            const mousePos = getMousePos(canvas, evt);
            const clickedTree = trees.find(tree => isPointInTree(mousePos.x, mousePos.y, tree));

            if (clickedTree) {
                displayTreeDetails(clickedTree);
                updateURLParameter(clickedTree.id);
            }
        });

        makeNoteButton.addEventListener('click', function () {
            noteFormContainer.style.display = 'block'; // Show note form on button click
            makeNoteButton.style.display = 'none';
            updateGoogleForm(selectedTreeId); // Load form for the selected tree
        });

        fetchTreeData();
    </script>
</body>

</html>