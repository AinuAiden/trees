<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Orchard Map</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #E4F3E5;
        }
        #container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
        }
        #treeDetails {
            padding: 15px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: calc(50% - 20px);
            text-align: left;
        }
        #treeDetails strong {
            color: #2c7a7b;
        }
        #formContainer {
            margin-bottom: 20px;
            width: 50%;
        }
        #formContainer iframe {
            width: 100%;
            height: 573px;
        }
        #canvasContainer {
            position: relative;
            width: calc(50%);
        }
        #orchardCanvas {
            width: 100%;
            height: auto;
        }
        #hoverInfo {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 5px;
            display: none;
            pointer-events: none;
        }
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            #treeDetails, #canvasContainer {
                width: 100%;
                margin-bottom: 20px;
            }
            #treeDetails {
                font-size: 14px;
            }
            #hoverInfo {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="treeDetails"></div>
        <div id="canvasContainer">
            <canvas id="orchardCanvas" width="250" height="500"></canvas>
            <div id="hoverInfo"></div>
        </div>
    </div>
    <div id="formContainer">
        <iframe id="googleForm" src="" frameborder="0" marginheight="0" marginwidth="0" tabindex="-1">Loadingâ€¦</iframe>
    </div>
    <script>
        const MAP_SCALE = 1.4;
        const PADDING = 40;
        const canvas = document.getElementById('orchardCanvas');
        const ctx = canvas.getContext('2d');
        const treeDetailsDiv = document.getElementById('treeDetails');
        const hoverInfoDiv = document.getElementById('hoverInfo');
        const googleForm = document.getElementById('googleForm');
        let trees = [];
        let selectedTreeId = null;

        class Tree {
            constructor(x, y, id, cultivar, rootstock, notes, nickname = '') {
                this.x = canvas.width - (x * MAP_SCALE + PADDING);
                this.y = (y + 30) * MAP_SCALE + PADDING;
                this.id = id;
                this.cultivar = cultivar;
                this.rootstock = rootstock;
                this.notes = notes;
                this.nickname = nickname;
            }

            getNotes() {
                return this.notes;
            }
        }

        function drawTrees() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            trees.forEach(tree => {
                ctx.beginPath();
                ctx.arc(tree.x, tree.y, tree.id === selectedTreeId ? 7 : 5, 0, Math.PI * 2);
                ctx.fillStyle = tree.id === selectedTreeId ? 'red' : 'green';
                ctx.fill();
            });
        }

        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (evt.clientX - rect.left) * (canvas.width / rect.width),
                y: (evt.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function isPointInTree(x, y, tree) {
            const distance = Math.sqrt((x - tree.x) ** 2 + (y - tree.y) ** 2);
            return distance <= 5;
        }

        function displayTreeDetails(tree) {
            selectedTreeId = tree.id;
            treeDetailsDiv.innerHTML = `
                <h2>${tree.cultivar} [${tree.id}]</h2>
                <p><strong>Nickname:</strong> ${tree.nickname}</p>
                <p><strong>Cultivar:</strong> ${tree.cultivar}</p>
                <p><strong>Rootstock:</strong> ${tree.rootstock}</p>
                <p><strong>Notes:</strong> ${tree.getNotes()}</p>
            `;
            updateGoogleForm(tree.id);
            drawTrees();
        }

        function showHoverInfo(tree, x, y) {
            hoverInfoDiv.style.display = 'block';
            hoverInfoDiv.style.left = `${x + 10}px`;
            hoverInfoDiv.style.top = `${y + 10}px`;
            hoverInfoDiv.innerHTML = `
                <strong>Tree ID:</strong> ${tree.id}<br>
                <strong>Nickname:</strong> ${tree.nickname}<br>
                <strong>Cultivar:</strong> ${tree.cultivar}<br>
                <strong>Rootstock:</strong> ${tree.rootstock}
            `;
        }

        function updateURLParameter(treeId) {
            const url = new URL(window.location);
            url.searchParams.set('treeId', treeId);
            window.history.pushState({}, '', url);
        }

        function updateGoogleForm(treeId) {
            const formUrl = `https://docs.google.com/forms/d/e/1FAIpQLSd4n5wpalR97KiW5ppOsb1fnqSRI2W4B_VH4x_y8y0F36UaQg/viewform?embedded=true&usp=pp_url&entry.1147721308=${treeId}`;
            if (googleForm.src !== formUrl) {
                googleForm.src = formUrl;
            }
        }


        function fetchTreeData() {
            const sheetId = '1mhKGDDzsK3mj2JOKjMg5knaIQE-ZaWAg5LLgogw7wXw';
            const sheetRange = 'Sheet1!A2:G';
            const apiKey = 'AIzaSyBs9Du6hrji1fMUaUcbAy7nviu7EssKkV0';
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetRange}?key=${apiKey}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    trees = data.values.map(row => new Tree(
                        parseFloat(row[0]),
                        parseFloat(row[1]),
                        row[2],
                        row[3],
                        row[4],
                        row[5],
                        row[6] || ''
                    ));
                    drawTrees();
                    initialize();
                })
                .catch(error => console.error('Error loading the Google Sheet:', error));
        }

        function initialize() {
            const treeId = new URLSearchParams(window.location.search).get('treeId');
            if (treeId) {
                const selectedTree = trees.find(tree => tree.id === treeId);
                if (selectedTree) {
                    displayTreeDetails(selectedTree);
                } else {
                    treeDetailsDiv.innerHTML = 'Tree not found.';
                }
            } else {
                updateGoogleForm(''); // Reset form if no tree is selected
            }
        }

        canvas.addEventListener('mousemove', function(evt) {
            const mousePos = getMousePos(canvas, evt);
            const hoveredTree = trees.find(tree => isPointInTree(mousePos.x, mousePos.y, tree));
            
            if (hoveredTree) {
                showHoverInfo(hoveredTree, mousePos.x, mousePos.y);
            } else {
                hoverInfoDiv.style.display = 'none';
            }
        });

        canvas.addEventListener('click', function(evt) {
            const mousePos = getMousePos(canvas, evt);
            const clickedTree = trees.find(tree => isPointInTree(mousePos.x, mousePos.y, tree));

            if (clickedTree) {
                displayTreeDetails(clickedTree);
                updateURLParameter(clickedTree.id);
            }
        });

        fetchTreeData();
    </script>
</body>
</html>
